# tests/test_process_api.py
import pytest
from httpx import AsyncClient
from app.main import app


@pytest.mark.asyncio
async def test_process_chunks():
    # Пример входных данных
    payload = {
        "chunks": [
    "Иван: Добрый день, Николай. Хотел бы обсудить стратегию формирования бюджета на следующий квартал. У нас есть несколько ключевых направлений, которые требуют внимания и финансирования, чтобы обеспечить рост и развитие компании.",
    "Николай: Добрый день, Иван. Конечно, давайте вместе посмотрим на основные статьи расходов и приоритеты. Какие направления вы считаете наиболее важными для этого периода?",
    "Иван: В первую очередь, необходимо увеличить инвестиции в маркетинг, чтобы расширить присутствие бренда на рынке и привлечь новых клиентов. Также планируем обновить оборудование в производственном цехе для повышения эффективности и качества продукции. Не менее важно — инвестировать в обучение сотрудников, чтобы повысить их профессиональный уровень и мотивацию.",
    "Николай: Понимаю. По поводу маркетинга — есть ли конкретные кампании или каналы продвижения, на которые стоит выделить больше средств? И как вы планируете измерять их эффективность?",
    "Иван: Мы хотим сосредоточиться на цифровых платформах — социальных сетях, контекстной рекламе и email-рассылках. Планируем запустить несколько крупных рекламных кампаний с четкими KPI по привлечению трафика и конверсиям. Для оценки эффективности будем использовать аналитические инструменты и отчеты по ROI.",
    "Николай: Хорошо. А по обновлению оборудования — какой объем инвестиций запланирован? Есть ли уже поставщики или нужно провести тендерный процесс?",
    "Иван: Общая сумма инвестиций составляет около 2 миллионов рублей. Мы собираем предложения от нескольких поставщиков, сравниваем цены и условия, чтобы выбрать наиболее выгодное решение по соотношению цена-качество. Планируем завершить выбор в течение следующего месяца.",
    "Николай: Отлично. А что касается обучения сотрудников — сколько средств предполагается выделить? Какие темы будут приоритетными?",
    "Иван: На развитие навыков продаж и работу с новыми технологиями в производстве мы выделим примерно 500 тысяч рублей. Основные темы — современные методы продаж, работа с CRM-системами и повышение квалификации в области автоматизации процессов.",
    "Николай: Понятно. Есть ли еще какие-то статьи расходов или резервные фонды, которые стоит учесть при формировании бюджета?",
    "Иван: Да, мы обязательно оставим резервный фонд примерно 10% от общего бюджета для непредвиденных расходов или форс-мажорных ситуаций. Также предусмотрены расходы на командировки и непредвиденные технические работы.",
    "Николай: Хорошо, Иван. Тогда предлагаю подготовить предварительный проект бюджета с учетом всех этих пунктов и обсудить его на следующей неделе с руководством для утверждения.",
    "Иван: Отличная идея. Я подготовлю все необходимые расчеты и документы к тому времени. Благодарю за сотрудничество!",
    "Николай: Взаимно, Иван. Буду ждать вашего проекта и продолжим работу над этим важным вопросом."
]
    }

    async with AsyncClient(app=app, base_url="http://testserver") as ac:
        response = await ac.post("/process/", json=payload)

    # Проверка статуса
    assert response.status_code == 200

    data = response.json()

    # Проверяем, что вернулся final_summary
    assert "final_summary" in data
    assert isinstance(data["final_summary"], str)
    assert len(data["final_summary"]) > 0
